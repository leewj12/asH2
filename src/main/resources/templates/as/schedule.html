<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8" />
    <title>일정 내역</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="bg-gray-50 p-4 md:p-6 text-sm">
<div class="mx-auto w-full max-w-[1700px]">

    <h2 class="text-xl font-semibold mb-3 md:mb-4">
        일정 내역
        <span class="align-middle ml-2 text-xs px-2 py-1 rounded bg-slate-100 text-slate-700" title="기간 필터의 기준">
      필터 기준: <strong>예정일</strong>
    </span>
    </h2>

    <!-- ── 문제유형 칩(접수목록과 동일) ── -->
    <div class="mb-3 md:mb-4 flex flex-wrap gap-2">
        <button type="button" class="chip-asType px-3 h-8 rounded-full border bg-white hover:bg-gray-50 text-gray-700" data-value="ALL">전체</button>
        <button type="button" class="chip-asType px-3 h-8 rounded-full border bg-white hover:bg-gray-50 text-gray-700" data-value="장비">장비</button>
        <button type="button" class="chip-asType px-3 h-8 rounded-full border bg-white hover:bg-gray-50 text-gray-700" data-value="네트워크">네트워크</button>
        <button type="button" class="chip-asType px-3 h-8 rounded-full border bg-white hover:bg-gray-50 text-gray-700" data-value="모듈">모듈</button>
        <button type="button" class="chip-asType px-3 h-8 rounded-full border bg-white hover:bg-gray-50 text-gray-700" data-value="기타">기타</button>
        <span class="text-xs text-gray-400 ml-1">정렬 · 세부 검색은 고급필터를 이용해 주세요.</span>
    </div>

    <!-- 상단: 자유검색 + 고급필터 + 페이지크기 + 초기화 + 엑셀 -->
    <div class="mb-3 md:mb-4 flex flex-wrap items-center gap-2">
        <input id="qInput" type="text" placeholder="농가명/농가코드/지역/사업/담당자 등 자유 검색"
               th:value="${param.q}"
               class="flex-1 min-w-[180px] border rounded px-3 h-9 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="btnQuickSearch" class="h-9 px-4 rounded bg-blue-600 text-white">검색</button>
        <button id="btnOpenFilters" class="h-9 px-4 rounded border bg-white hover:bg-gray-50">고급 필터</button>

        <button id="btnResetAll" class="h-9 px-4 rounded border bg-white hover:bg-gray-50">초기화</button>

        <label for="sizeSelect" class="text-gray-600 ml-2">페이지 크기</label>
        <select id="sizeSelect" name="size"
                class="border rounded px-3 h-9 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="10"  th:selected="${param.size == null or param.size == '10'}">10개씩</option>
            <option value="50"  th:selected="${param.size == '50'}">50개씩</option>
            <option value="100" th:selected="${param.size == '100'}">100개씩</option>
        </select>

        <a id="btnExport" class="ml-auto inline-flex items-center gap-2 px-3 h-9 rounded border bg-white hover:bg-gray-50"
           href="#">엑셀 다운로드</a>
    </div>

    <!-- 데스크탑 테이블 -->
    <section class="hidden md:block">
        <div class="bg-white rounded-md shadow">
            <table class="w-full divide-y divide-gray-200 text-xs lg:text-sm">
                <thead class="bg-gray-100 text-gray-700 font-semibold text-left">
                <tr>
                    <!-- th 체크박스(엑셀 컬럼 선택) -->
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="asId" checked><span>AS</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="farmName" checked><span>농가명</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="farmCode" checked><span>농가코드</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="regionName" checked><span>지역</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="projectName" checked><span>사업명</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="asType" checked><span>문제유형</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="reqDate" checked><span>접수일</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="planDate" checked><span>예정일</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="completeDate" checked><span>완료일</span></div></th>
                    <th class="px-3 py-2"><div class="flex items-center gap-2"><input type="checkbox" class="ck-col" value="completedMark" checked><span>완료</span></div></th>
                </tr>
                </thead>

                <tbody class="bg-white divide-y divide-gray-200">
                <tr th:each="row : ${rowList}"
                    class="hover:bg-blue-50 cursor-pointer"
                    th:onclick="|window.location='/as/detail/' + ${row.asId}|">
                    <td class="px-3 py-2" th:text="${row.asId}"></td>
                    <td class="px-3 py-2" th:text="${row.farmName}"></td>
                    <td class="px-3 py-2" th:text="${row.farmCode}"></td>
                    <td class="px-3 py-2" th:text="${row.regionName}"></td>
                    <td class="px-3 py-2"><div class="truncate max-w-[12rem] xl:max-w-[16rem]" th:text="${row.projectName}" th:title="${row.projectName}"></div></td>
                    <td class="px-3 py-2"><div class="truncate max-w-[12rem] xl:max-w-[16rem]" th:text="${row.asType}" th:title="${row.asType}"></div></td>
                    <td class="px-3 py-2" th:text="${row.reqDate != null ? #temporals.format(row.reqDate, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                    <td class="px-3 py-2" th:text="${row.planDate != null ? #temporals.format(row.planDate, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                    <td class="px-3 py-2" th:text="${row.completeDate != null ? #temporals.format(row.completeDate, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                    <td class="px-3 py-2 font-medium"
                        th:text="${row.completionLabel == '완료' ? 'O' : 'X'}"
                        th:classappend="${row.completionLabel == '완료'} ? ' text-blue-600' : ' text-gray-500'"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(rowList)}">
                    <td colspan="10" class="px-4 py-4 text-gray-500 text-center">조회된 데이터가 없습니다</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- 모바일 카드 -->
    <section class="md:hidden space-y-2">
        <div th:each="row : ${rowList}"
             class="bg-white rounded-xl shadow p-3 border cursor-pointer"
             th:onclick="|window.location='/as/detail/' + ${row.asId}|">
            <div class="flex items-center justify-between">
                <div class="font-semibold">AS #<span th:text="${row.asId}"></span></div>
                <span class="text-xs px-2 py-1 rounded-full"
                      th:text="${row.completionLabel == '완료' ? 'O' : 'X'}"
                      th:classappend="${row.completionLabel == '완료'} ? ' bg-blue-100 text-blue-700' : ' bg-gray-100 text-gray-600'"></span>
            </div>
            <div class="mt-1 text-sm text-gray-900 flex items-center gap-2">
                <span class="truncate max-w-[60%]" th:text="${row.farmName}" th:title="${row.farmName}"></span>
                <span class="text-gray-400">·</span>
                <span class="text-gray-600" th:text="${row.farmCode}"></span>
            </div>
            <div class="mt-1 text-gray-600">
                <span class="truncate block" th:text="'사업: ' + (${row.projectName})" th:title="${row.projectName}"></span>
                <span class="truncate block" th:text="'유형: ' + (${row.asType})" th:title="${row.asType}"></span>
            </div>
            <div class="mt-1 text-gray-600 grid grid-cols-2 gap-1">
                <div>
                    <span class="text-gray-500">접수</span>
                    <span class="ml-1" th:text="${row.reqDate != null ? #temporals.format(row.reqDate, 'yyyy-MM-dd HH:mm') : '-'}"></span>
                </div>
                <div class="text-right">
                    <span class="text-gray-500">예정</span>
                    <span class="ml-1" th:text="${row.planDate != null ? #temporals.format(row.planDate, 'yyyy-MM-dd HH:mm') : '-'}"></span>
                </div>
            </div>
            <div class="mt-1 text-gray-600">
                <span class="text-gray-500">완료</span>
                <span class="ml-1" th:text="${row.completeDate != null ? #temporals.format(row.completeDate, 'yyyy-MM-dd HH:mm') : '-'}"></span>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(rowList)}" class="px-4 py-4 text-gray-500 text-center">조회된 데이터가 없습니다</div>
    </section>

    <!-- 페이징 -->
    <div class="mt-6 mb-3 flex justify-center" th:if="${totalPages > 1}">
        <ul class="flex gap-1">
            <li th:if="${page > 1}">
                <a th:href="@{/as/schedule(
          q=${param.q}, farms=${param.farms}, types=${param.types}, tables=${param.tables}, equipName=${param.equipName},
          completion=${param.completion}, period=${param.period},
          startDate=${param.startDate}, endDate=${param.endDate},
          sortField=${param.sortField}, sortDir=${param.sortDir},
          page=${page - 1}, size=${param.size})}"
                   class="px-3 py-1 border rounded bg-white text-gray-600 hover:bg-gray-100">&lt;</a>
            </li>
            <li th:each="i : ${#numbers.sequence(1, totalPages)}">
                <a th:href="@{/as/schedule(
          q=${param.q}, farms=${param.farms}, types=${param.types}, tables=${param.tables}, equipName=${param.equipName},
          completion=${param.completion}, period=${param.period},
          startDate=${param.startDate}, endDate=${param.endDate},
          sortField=${param.sortField}, sortDir=${param.sortDir},
          page=${i}, size=${param.size})}"
                   th:text="${i}"
                   th:classappend="${i == page} ? 'bg-blue-500 text-white' : 'bg-white text-gray-700'
             + ' px-3 py-1 border rounded hover:bg-gray-100'"
                   class="px-3 py-1 border rounded">
                </a>
            </li>
            <li th:if="${page < totalPages}">
                <a th:href="@{/as/schedule(
          q=${param.q}, farms=${param.farms}, types=${param.types}, tables=${param.tables}, equipName=${param.equipName},
          completion=${param.completion}, period=${param.period},
          startDate=${param.startDate}, endDate=${param.endDate},
          sortField=${param.sortField}, sortDir=${param.sortDir},
          page=${page + 1}, size=${param.size})}"
                   class="px-3 py-1 border rounded bg-white text-gray-600 hover:bg-gray-100">&gt;</a>
            </li>
        </ul>
    </div>

</div>

<!-- Overlay -->
<div id="filterOverlay" class="fixed inset-0 bg-black/30 hidden z-40"></div>

<!-- Drawer -->
<aside id="filterDrawer"
       class="fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-xl z-50 translate-x-full transition-transform
              flex flex-col h-[100dvh]">
    <header class="h-12 px-4 flex items-center justify-between border-b">
        <h3 class="font-semibold">고급 필터</h3>
        <button id="btnCloseFilters" class="p-2">✕</button>
    </header>

    <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm pb-28"
         style="padding-bottom: calc(env(safe-area-inset-bottom) + 5rem);">

        <!-- 농장(다중, CSV) -->
        <div>
            <label class="block font-medium mb-1">농가 다중 검색( ',' 로 구분)</label>
            <input id="farmsInput" type="text" placeholder="예: 인프로, 농장"
                   class="w-full border rounded px-3 h-9">
        </div>

        <!-- 문제유형(다중) -->
        <div>
            <label class="block font-medium mb-1">문제유형</label>
            <div id="typesGroup" class="flex flex-wrap gap-2">
                <label class="inline-flex items-center gap-1"><input type="checkbox" value="장비"> 장비</label>
                <label class="inline-flex items-center gap-1"><input type="checkbox" value="네트워크"> 네트워크</label>
                <label class="inline-flex items-center gap-1"><input type="checkbox" value="모듈"> 모듈</label>
                <label class="inline-flex items-center gap-1"><input type="checkbox" value="기타"> 기타</label>
            </div>
        </div>

        <!-- 장비 카테고리(다중) + 장비명 -->
        <div>
            <label class="block font-medium text-gray-700 mb-1">장비 카테고리</label>
            <div id="tablesGroup" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                <label class="inline-flex items-center gap-1" th:each="tn : ${tableNames}">
                    <input type="checkbox" class="cb-table" th:value="${tn}">
                    <span th:text="${tn}">TABLE</span>
                </label>
            </div>
            <div class="mt-2">
                <label class="block font-medium text-gray-700 mb-1" for="equipNameInput">장비명</label>
                <input type="text" id="equipNameInput" name="equipName" th:value="${param.equipName}"
                       placeholder="예: 사료빈" class="w-full border rounded px-3 h-9
               focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- 완료여부 -->
        <div>
            <label class="block font-medium mb-1">완료여부</label>
            <div id="completionGroup" class="flex flex-wrap gap-3">
                <label class="inline-flex items-center gap-1"><input type="radio" name="completion" value=""> 전체</label>
                <label class="inline-flex items-center gap-1"><input type="radio" name="completion" value="완료"> 완료</label>
                <label class="inline-flex items-center gap-1"><input type="radio" name="completion" value="미완료"> 미완료</label>
            </div>
        </div>

        <!-- 기간 프리셋 + 날짜 -->
        <div>
            <label class="block font-medium mb-1">기간</label>
            <div class="flex flex-wrap items-center gap-3">
                <label class="inline-flex items-center gap-1"><input type="radio" name="period" value=""> 전체</label>
                <label class="inline-flex items-center gap-1"><input type="radio" name="period" value="today"> 오늘</label>
                <label class="inline-flex items-center gap-1"><input type="radio" name="period" value="1w"> 1주</label>
                <label class="inline-flex items-center gap-1"><input type="radio" name="period" value="1m"> 1개월</label>
            </div>
            <p class="text-xs text-gray-500 mt-1">* 프리셋 선택 시 날짜 범위는 무시합니다</p>

            <div class="mt-2 grid grid-cols-2 gap-2">
                <input id="startDateInput" type="date" class="border rounded px-3 h-9">
                <input id="endDateInput"   type="date" class="border rounded px-3 h-9">
            </div>
        </div>

        <!-- 정렬 -->
        <div>
            <label class="block font-medium mb-1">정렬</label>
            <div class="flex items-center gap-2">
                <select id="sortFieldInput" class="border rounded px-3 h-9">
                    <option value="planDate">예정일</option>
                    <option value="completeDate">완료일</option>
                    <option value="asId">AS_ID</option>
                    <option value="farmName">농가명</option>
                    <option value="farmCode">농가코드</option>
                    <option value="regionName">지역</option>
                    <option value="projectName">사업명</option>
                    <option value="asType">문제유형</option>
                    <option value="reqDate">접수일</option>
                </select>
                <select id="sortDirInput" class="border rounded px-3 h-9">
                    <option value="asc">오름차순</option>
                    <option value="desc">내림차순</option>
                </select>
            </div>
        </div>
    </div>

    <footer class="p-4 border-t bg-white flex justify-between shrink-0 sticky bottom-2"
            style="padding-bottom: env(safe-area-inset-bottom);">
        <button id="btnResetFilters" class="px-4 h-10 rounded border bg-white hover:bg-gray-50">초기화</button>
        <div class="space-x-2">
            <button id="btnClose2" class="px-4 h-10 rounded border bg-white hover:bg-gray-50">닫기</button>
            <button id="btnApplyFilters" class="px-4 h-10 rounded bg-blue-600 text-white">적용</button>
        </div>
    </footer>
</aside>

<!-- ===== Scripts ===== -->

<!-- 1) 칩 전용 (types) -->
<script>
    (function TypeChipsOnly(){
      const chips = document.querySelectorAll('.chip-asType');
      const fromCsv = s => (s ? s.split(',').map(v=>v.trim()).filter(Boolean) : []);
      const getSet = () => new Set(fromCsv(new URLSearchParams(location.search).get('types')));

      function render(){
        const set = getSet();
        chips.forEach(btn => {
          const v = btn.getAttribute('data-value');
          const active = (v === 'ALL') ? (set.size === 0) : set.has(v);
          btn.classList.toggle('text-black', active);
          btn.classList.toggle('border-blue-600', active);
          btn.classList.toggle('text-gray-700', !active);
        });
      }

      function navigateWithTypes(set){
        // 드로어 체크박스와 동기화 이벤트
        window.dispatchEvent(new CustomEvent('types-change', { detail: { types: [...set], source:'chips' }}));

        const p = new URLSearchParams(location.search);
        set.size ? p.set('types', [...set].join(',')) : p.delete('types');
        p.set('page','1');
        const sizeSel = document.getElementById('sizeSelect');
        p.set('size', p.get('size') || (sizeSel ? sizeSel.value : '10'));
        location.search = p.toString();
      }

      function onClick(v){
        const set = getSet();
        if (v === 'ALL'){ set.clear(); navigateWithTypes(set); return; }
        set.has(v) ? set.delete(v) : set.add(v);
        navigateWithTypes(set);
      }

      chips.forEach(ch => ch.addEventListener('click', () => onClick(ch.getAttribute('data-value'))));
      render();
    })();
</script>

<!-- 2) 고급필터 드로어 -->
<script>
    (function AdvancedFilters(){
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const toCsv   = (arr) => arr.filter(Boolean).join(",");
      const fromCsv = (s) => (s ? s.split(",").map(v=>v.trim()).filter(Boolean) : []);
      const params  = new URLSearchParams(location.search);

      // ── 드로어 open/close ───────────────────────────────────────────────
      const drawer  = $('#filterDrawer');
      const overlay = $('#filterOverlay');
      const open  = () => { drawer?.classList.remove('translate-x-full'); overlay?.classList.remove('hidden'); };
      const close = () => { drawer?.classList.add('translate-x-full');  overlay?.classList.add('hidden');     };
      $('#btnOpenFilters')?.addEventListener('click', open);
      $('#btnCloseFilters')?.addEventListener('click', close);
      $('#btnClose2')?.addEventListener('click', close);
      overlay?.addEventListener('click', close);

      // ── 요소 ────────────────────────────────────────────────────────────
      const qInput           = $('#qInput');
      const farmsInput       = $('#farmsInput');
      const typesGroup       = $('#typesGroup');
      const tablesGroup      = $('#tablesGroup');
      const equipNameInput   = $('#equipNameInput');
      const periodRadios     = $$('input[name="period"]');
      const completionRadios = $$('input[name="completion"]');
      const sortFieldInput   = $('#sortFieldInput');
      const sortDirInput     = $('#sortDirInput');
      const startDateInput   = $('#startDateInput');
      const endDateInput     = $('#endDateInput');

      // ── 초기 주입 ───────────────────────────────────────────────────────
      if (qInput)         qInput.value         = params.get('q') || '';
      if (farmsInput)     farmsInput.value     = params.get('farms') || '';
      if (equipNameInput) equipNameInput.value = params.get('equipName') || '';
      if (sortFieldInput) sortFieldInput.value = params.get('sortField') || 'planDate';
      if (sortDirInput)   sortDirInput.value   = params.get('sortDir')   || 'asc';

      if (periodRadios.length) {
        const cur = params.get('period') || '';
        periodRadios.forEach(r => r.checked = (r.value === cur));
      }
      if (completionRadios.length) {
        const cur = params.get('completion') || '';
        completionRadios.forEach(r => r.checked = (r.value === cur));
      }

      const _datePart = (s) => (s ? String(s).substring(0,10) : '');
      if (startDateInput) startDateInput.value = _datePart(params.get('startDate') || '');
      if (endDateInput)   endDateInput.value   = _datePart(params.get('endDate')   || '');

      const check = (sel, arr) => $$(sel+' input[type="checkbox"]').forEach(cb => cb.checked = arr.includes(cb.value));
      if (typesGroup)  check('#typesGroup',  fromCsv(params.get('types')  || ''));
      if (tablesGroup) check('#tablesGroup', fromCsv(params.get('tables') || ''));

      // 타입 체크 → 칩에 즉시 알림
      if (typesGroup) {
        typesGroup.addEventListener('change', () => {
          const types = $$('#typesGroup input:checked').map(x=>x.value);
          window.dispatchEvent(new CustomEvent('types-change', { detail: { types, source:'drawer' }}));
        });
      }

      // ── 적용 ────────────────────────────────────────────────────────────
      $('#btnApplyFilters')?.addEventListener('click', () => {
        const p = new URLSearchParams(location.search);

        // q
        if (qInput){ const v = qInput.value.trim(); v ? p.set('q', v) : p.delete('q'); }

        // 농장 CSV
        if (farmsInput){ const v = farmsInput.value.trim(); v ? p.set('farms', v) : p.delete('farms'); }

        // 유형/장비카테고리
        if (typesGroup){
          const arr = $$('#typesGroup input:checked').map(x=>x.value);
          arr.length ? p.set('types', toCsv(arr)) : p.delete('types');
        }
        if (tablesGroup){
          const arr = $$('#tablesGroup .cb-table:checked').map(x=>x.value);
          arr.length ? p.set('tables', toCsv(arr)) : p.delete('tables');
        }

        // 장비명
        if (equipNameInput){ const v = equipNameInput.value.trim(); v ? p.set('equipName', v) : p.delete('equipName'); }

        // 완료여부
        if (completionRadios.length){
          const v = completionRadios.find(r => r.checked)?.value || '';
          v ? p.set('completion', v) : p.delete('completion');
        }

        // 기간 (프리셋 우선)
        if (periodRadios.length){
          const picked = periodRadios.find(r => r.checked)?.value || '';
          picked ? p.set('period', picked) : p.delete('period');
          if (picked) { p.delete('startDate'); p.delete('endDate'); }
        }

        // 사용자 날짜(종료일 포함)
        if (!p.get('period') && startDateInput && endDateInput){
          let sd = (startDateInput.value || '').trim();
          let ed = (endDateInput.value   || '').trim();
          if (sd && !ed) ed = sd;
          if (ed && !sd) sd = ed;
          if (sd) p.set('startDate', `${sd}T00:00`); else p.delete('startDate');
          if (ed) p.set('endDate',   `${ed}T23:59:59`); else p.delete('endDate');
        }

        // 정렬 + 페이지 리셋
        if (sortFieldInput) p.set('sortField', sortFieldInput.value);
        if (sortDirInput)   p.set('sortDir',   sortDirInput.value);
        p.set('page','1');
        const sizeSel = document.getElementById('sizeSelect');
        p.set('size', p.get('size') || (sizeSel ? sizeSel.value : '10'));

        location.search = p.toString();
      });

      // ── 상단 퀵검색 버튼(+Enter) ────────────────────────────────────────
      const runQuickSearch = () => {
        const p = new URLSearchParams(location.search);
        const v = (qInput?.value || '').trim();
        v ? p.set('q', v) : p.delete('q');
        p.set('page','1');
        const sizeSel = document.getElementById('sizeSelect');
        p.set('size', p.get('size') || (sizeSel ? sizeSel.value : '10'));
        location.search = p.toString();
      };
      $('#btnQuickSearch')?.addEventListener('click', runQuickSearch);

      // Enter 유틸 (IME 조합 중 Enter 무시)
      const onEnter = (el, fn) => {
        if (!el) return;
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.isComposing) {
            e.preventDefault();
            fn?.();
          }
        });
      };
      // 상단 q 입력: Enter → 퀵검색
      onEnter(qInput, runQuickSearch);
      // 드로어 주요 입력들: Enter → 적용
      [farmsInput, equipNameInput, startDateInput, endDateInput, sortFieldInput, sortDirInput]
        .forEach(el => onEnter(el, () => $('#btnApplyFilters')?.click()));
      // 라디오(기간/완료)도 Enter → 적용
      periodRadios.forEach(r => onEnter(r, () => $('#btnApplyFilters')?.click()));
      completionRadios.forEach(r => onEnter(r, () => $('#btnApplyFilters')?.click()));
      // 체크박스 컨테이너에서도 Enter → 적용
      ['#typesGroup', '#tablesGroup'].forEach(sel => {
        const box = $(sel);
        if (!box) return;
        box.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.isComposing) {
            e.preventDefault();
            $('#btnApplyFilters')?.click();
          }
        });
      });

      // ── 초기화(드로어 계열) ────────────────────────────────────────────
      $('#btnResetFilters')?.addEventListener('click', () => {
        const p = new URLSearchParams(location.search);
        ['q','farms','types','tables','equipName','completion','period','startDate','endDate','sortField','sortDir']
          .forEach(k => p.delete(k));
        p.set('page','1');
        const sizeSel = document.getElementById('sizeSelect');
        p.set('size', p.get('size') || (sizeSel ? sizeSel.value : '10'));
        location.search = p.toString();
      });

      // ── 상단 초기화(간단) ───────────────────────────────────────────────
      $('#btnResetAll')?.addEventListener('click', () => {
        const p = new URLSearchParams(location.search);
        ['q','farms','types','tables','equipName','completion','period','startDate','endDate','sortField','sortDir']
          .forEach(k => p.delete(k));
        p.set('page','1');
        location.search = p.toString();
      });

      // ── 엑셀: th 체크박스 선택 컬럼만 ───────────────────────────────────
      const btnExport = document.getElementById('btnExport');
      if (btnExport){
        btnExport.addEventListener('click', (e) => {
          e.preventDefault();
          const chosen = Array.from(document.querySelectorAll('.ck-col:checked')).map(cb => cb.value);
          if (chosen.length === 0) { alert('엑셀에 포함할 컬럼을 1개 이상 선택하세요.'); return; }
          const p = new URLSearchParams(window.location.search);
          p.delete('page'); p.delete('size');
          p.set('cols', chosen.join(','));
          const url = '/as/schedule/export?' + p.toString();
          window.location.href = url;
        });
      }
    })();
</script>

<!-- 3) 칩 ↔ 드로어 동기화 -->
<script>
    (function FiltersBinding(){
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const fromCsv = (s) => (s ? s.split(',').map(v=>v.trim()).filter(Boolean) : []);
      const getTypesFromURL = () => fromCsv((new URLSearchParams(location.search)).get('types'));

      function setChipActive(types) {
        const set = new Set(types || []);
        $$('.chip-asType').forEach(btn => {
          const v = btn.getAttribute('data-value');
          const active = (v === 'ALL') ? (set.size === 0) : set.has(v);
          btn.classList.toggle('text-black', active);
          btn.classList.toggle('border-blue-600', active);
          btn.classList.toggle('text-gray-700', !active);
        });
      }

      function setDrawerTypes(types) {
        const set = new Set(types || []);
        $$('#typesGroup input[type="checkbox"]').forEach(cb => { cb.checked = set.has(cb.value); });
      }

      // 초기 동기화: URL → 칩/드로어
      document.addEventListener('DOMContentLoaded', () => {
        const types = getTypesFromURL();
        setChipActive(types);
        setDrawerTypes(types);
      });

      // 양방향 바인딩
      window.addEventListener('types-change', (e) => {
        const types = (e.detail && Array.isArray(e.detail.types)) ? e.detail.types : [];
        setChipActive(types);
        setDrawerTypes(types);
      });
    })();
</script>

<!-- 4) 페이지 크기 -->
<script>
    (function PageSize(){
      const sizeSel = document.getElementById('sizeSelect');
      if (sizeSel){
        const p = new URLSearchParams(location.search);
        sizeSel.value = p.get('size') || sizeSel.value;
        sizeSel.addEventListener('change', () => {
          const q = new URLSearchParams(location.search);
          q.set('size', sizeSel.value);
          q.set('page','1');
          location.search = q.toString();
        });
      }
    })();
</script>

</body>
</html>