<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8" />
    <title>As ìƒì„¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body class="bg-gray-50 p-4 md:p-6">
<div class="mx-auto w-full bg-white p-4 md:p-6 rounded-2xl shadow max-w-[1500px]">
    <h2 class="text-xl md:text-2xl font-semibold mb-4 md:mb-6 border-b pb-2">As ìƒì„¸</h2>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ ë©”íƒ€: 2ì—´ ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ë†ì¥</label>
            <p class="mt-1 border rounded px-3 py-2 truncate"
               th:text="${as.farmName != null ? as.farmName + ' (' + as.farmCode + ')' : as.farmCode}"
               th:title="${as.farmName != null ? as.farmName + ' (' + as.farmCode + ')' : as.farmCode}"></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì‚¬ì—…ëª…</label>
            <p class="mt-1 border rounded px-3 py-2 truncate"
               th:text="${#strings.isEmpty(as.projectName) ? '-' : as.projectName}"
               th:title="${as.projectName}"></p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì§€ì—­</label>
            <p class="mt-1 border rounded px-3 py-2 truncate"
               th:text="${#strings.isEmpty(as.regionName) ? '-' : as.regionName}"
               th:title="${as.regionName}"></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì£¼ì†Œ</label>
            <p class="mt-1 border rounded px-3 py-2 truncate"
               th:text="${#strings.isEmpty(as.farmAddr1 + ' ' + as.farmAddr2) ? '-' : as.farmAddr1 + ' ' + as.farmAddr2}"
               th:title="${as.farmAddr1 + ' ' + as.farmAddr2}"></p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ëŒ€í‘œ</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.farmerName) ? '-' : as.farmerName}"></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.phoneNumb) ? '-' : as.phoneNumb}"></p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ì</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.reqUser) ? '-' : as.reqUser}"></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ì¼</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.reqDate) ? '-' : as.reqDate}"></p>
        </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë‹´ë‹¹/ì§„í–‰/ë¬¸ì œìœ í˜•: 3ì—´ë¡œ ë¬¶ì–´ì„œ í•œ ì¤„ì— â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 mb-6">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ë‹´ë‹¹ì</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.asManager) ? '-' : as.asManager}"></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ì§„í–‰ë„</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#strings.isEmpty(as.statusLabel) ? '-' : as.statusLabel}"
               th:classappend="
                 ${as.statusLabel == 'ëŒ€ê¸°'} ? ' text-gray-800' :
                 (${as.statusLabel == 'ì„ë°•'} ? ' text-orange-500' :
                 (${as.statusLabel == 'ì§„í–‰ì¤‘'} ? ' text-green-600' :
                 (${as.statusLabel == 'ì™„ë£Œ'} ? ' text-blue-600' :
                 (${as.statusLabel == 'ì§€ì—°'} ? ' text-red-600' :
                 (${as.statusLabel == 'ë³´ë¥˜'} ? ' text-gray-400' : '')))))">
            </p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ë¬¸ì œ ìœ í˜•</label>
<!--            <div class="mt-1">-->
<!--                <span class="inline-flex items-center text-[12px] px-2 py-1 rounded-full border truncate max-w-full"-->
                <p class="mt-1 border rounded px-3 py-2"
                      th:text="${#strings.isEmpty(as.asType) ? '-' : as.asType}"
                      th:classappend="${#strings.isEmpty(as.asType)} ? ' text-slate-500' :
                        (${as.asType == 'ì¥ë¹„'} ? ' text-blue-700' :
                        (${as.asType == 'ë„¤íŠ¸ì›Œí¬'} ? ' text-indigo-700' :
                        (${as.asType == 'ëª¨ë“ˆ'} ? ' text-emerald-700' :
                        ' text-slate-700')))">
                    -
<!--                </span>-->
                </p>
<!--            </div>-->
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-6">
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ë“±ë¡ì¼</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#temporals.format(as.regDate, 'yyyy-MM-dd HH:mm')} ?: '-' "></p>
        </div>
        <div class="min-w-0">
            <label class="block text-sm font-medium text-gray-700">ìˆ˜ì •ì¼</label>
            <p class="mt-1 border rounded px-3 py-2"
               th:text="${#temporals.format(as.updDate, 'yyyy-MM-dd HH:mm')} ?: '-' "></p>
        </div>
    </div>

    <!-- ì ‘ìˆ˜ ë‚´ìš© -->
    <section class="mb-6">
        <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ ë‚´ìš©</label>
        <textarea class="w-full mt-1 border rounded px-3 py-2" rows="3" readonly
                  th:text="${#strings.isEmpty(as.reqContent) ? '-' : as.reqContent}"></textarea>
    </section>

    <!-- AS ì¼ì • (ì¹´ë“œí˜•, ìƒì„¸ ë·°ì— ë§ê²Œ ì •ë¦¬) -->
    <section class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <label class="text-base md:text-lg font-semibold text-gray-800">AS ì¼ì •</label>
<!--            <span class="text-xs text-gray-400" th:if="${as.scheduleList != null and !as.scheduleList.isEmpty()}">ì™„ë£Œë˜ì§€ ì•Šì€ ì¼ì •ì€ ë²„íŠ¼ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬</span>-->
        </div>

        <div th:if="${as.scheduleList != null and !as.scheduleList.isEmpty()}"
             class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">

            <div th:each="s, iter : ${as.scheduleList}"
                 class="rounded-xl border border-gray-200 bg-white shadow p-3 md:p-4"
                 th:attr="
                   data-sid=${s.scheduleId},
                   data-plan=${s.planDate != null ? #temporals.format(s.planDate, 'yyyy-MM-dd''T''HH:mm:ss') : ''},
                   data-content=${s.asContent}">

                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                        <span class="text-sm font-medium text-gray-800" th:text="${'ì¼ì • #' + iter.count}">ì¼ì •</span>
                    </div>
                    <span th:if="${s.completeDate != null}" class="text-xs text-blue-600">ì™„ë£Œë¨</span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4 mb-3">
                    <div>
                        <label class="text-sm text-gray-500">ì˜ˆì •ì¼</label>
                        <div class="border px-3 py-2 rounded text-gray-900 text-sm">
                            <span th:text="${s.planDate != null ? #temporals.format(s.planDate, 'yyyy-MM-dd HH:mm') : '-'}">-</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">ì™„ë£Œì¼</label>
                        <div class="border px-3 py-2 rounded text-gray-900 text-sm">
                            <span data-complete-span
                                  th:text="${s.completeDate != null ? #temporals.format(s.completeDate, 'yyyy-MM-dd HH:mm') : '-'}">-</span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="text-sm text-gray-500 mb-1 block">ì ê²€ ë‚´ìš©</label>
                    <textarea readonly rows="4"
                              class="w-full border rounded px-3 py-2 text-gray-800 text-sm"
                              th:text="${s.asContent != null and !s.asContent.isEmpty() ? s.asContent : '-'}">-</textarea>
                </div>

                <div class="flex items-center gap-2">
                    <button th:if="${s.completeDate == null}"
                            type="button"
                            class="btn-complete-now inline-flex items-center gap-1 px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
                        âœ“ ì™„ë£Œ
                    </button>
                    <span th:if="${s.completeDate == null}"
                          class="text-xs text-gray-400">â€» í´ë¦­ ì‹œ ì™„ë£Œì¼ì´ í˜„ì¬ ì‹œê°ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</span>
                </div>
            </div>
        </div>

        <div th:if="${as.scheduleList == null or as.scheduleList.isEmpty()}"
             class="mt-2 px-4 py-3 bg-gray-100 border rounded text-gray-500 text-start">
            ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </section>

    <!-- ì¥ë¹„ ëª©ë¡ (ì¹´ë“œí˜•) -->
    <section class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <label class="block font-medium text-gray-700">ì¥ë¹„ ëª©ë¡</label>
        </div>

        <div th:if="${not #lists.isEmpty(as.equipList)}"
             class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
            <div th:each="equip : ${as.equipList}"
                 class="rounded-xl border border-gray-200 bg-white p-3 shadow-sm">

                <div class="flex items-center justify-between gap-2">
                    <div class="font-semibold truncate"
                         th:text="${#strings.isEmpty(equip.eqmntName) ? 'ë¯¸ë“±ë¡ ì¥ë¹„' : equip.eqmntName}">
                        ì¥ë¹„ëª…
                    </div>
                    <span
                            class="inline-flex items-center text-[11px] px-2 py-1 rounded-full border truncate max-w-[160px]"
                            th:text="${
                #strings.toUpperCase(equip.tableName) == 'UNREGISTERED'
                  ? 'ë¯¸ë“±ë¡ ì¥ë¹„'
                  : ( !#strings.isEmpty(equip.tableName) ? equip.tableName : 'UNKNOWN' )
              }"
                            th:classappend="${
                #strings.toUpperCase(equip.tableName) == 'UNREGISTERED' ?
                  ' bg-rose-50 text-rose-700 border-rose-200' :
                (#strings.toUpperCase(equip.tableName) == 'SF_TBL_EQMNT' ?
                  ' bg-blue-50 text-blue-700 border-blue-200' :
                  ' bg-slate-100 text-slate-700 border-slate-200')
              }">
            UNREGISTERED
          </span>
                </div>

                <div class="mt-2 space-y-1.5 text-sm" th:if="${#strings.toUpperCase(equip.tableName) != 'UNREGISTERED'}">
                    <div th:if="${#strings.toUpperCase(equip.tableName) == 'SF_TBL_EQMNT'}">
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">EQMNT_KIND</span>
                            <span class="text-gray-800 break-all"
                                  th:text="${equip.eqmntKind != null ? equip.eqmntKind : '-'}">-</span>
                        </div>
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">EQMNT_SEQ</span>
                            <span class="text-gray-800 break-all"
                                  th:text="${equip.eqmntSeq != null ? equip.eqmntSeq : '-'}">-</span>
                        </div>
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">ì„¤ì¹˜ì¼</span>
                            <span class="text-gray-800"
                                  th:text="${equip.useDate != null ? #temporals.format(equip.useDate, 'yyyy-MM-dd') : '-'}">-</span>
                        </div>
                    </div>

                    <div th:if="${#strings.toUpperCase(equip.tableName) != 'SF_TBL_EQMNT'}">
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">EQMNT_SEQ</span>
                            <span class="text-gray-800 break-all"
                                  th:text="${equip.eqmntSeq != null ? equip.eqmntSeq : '-'}">-</span>
                        </div>
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">SUB_SEQ</span>
                            <span class="text-gray-800 break-all"
                                  th:text="${equip.subSeq != null ? equip.subSeq : '-'}">-</span>
                        </div>
                        <div class="flex">
                            <span class="w-24 text-gray-500 shrink-0">ì„¤ì¹˜ì¼</span>
                            <span class="text-gray-800"
                                  th:text="${equip.useDate != null ? #temporals.format(equip.useDate, 'yyyy-MM-dd') : '-'}">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(as.equipList)}"
             class="mt-1 px-3 py-2 border rounded text-gray-500 text-start">
            ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </section>

    <!-- ì¡°ì¹˜ ê²°ê³¼ / ë¹„ê³  (ë¬¸ì œ ìœ í˜•ì€ ìƒë‹¨ ë°°ì§€ë¡œ ì´ë™) -->
    <section class="mb-4">
        <label class="block font-medium text-gray-700">ì¡°ì¹˜ ê²°ê³¼</label>
        <textarea class="w-full mt-1 border rounded px-3 py-2" rows="3" readonly
                  th:text="${#strings.isEmpty(as.asResult) ? '-' : as.asResult}"></textarea>
    </section>

    <section class="mb-6">
        <label class="block font-medium text-gray-700">ë¹„ê³ </label>
        <textarea class="w-full mt-1 border rounded px-3 py-2" rows="3" readonly
                  th:text="${#strings.isEmpty(as.etc) ? '-' : as.etc}"></textarea>
    </section>

    <!-- ì²¨ë¶€íŒŒì¼ (ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìŠ¤íƒ€ì¼) -->
    <section class="mb-6">
        <div class="flex items-center justify-between">
            <label class="block font-medium text-gray-700">ì²¨ë¶€íŒŒì¼</label>
            <button id="downloadAllBtn" class="hidden text-sm px-3 py-1 rounded border hover:bg-gray-50">ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <ul id="filePreviewList" class="mt-2 space-y-2 text-sm text-gray-700"></ul>
        <div id="noFiles" class="mt-2 px-4 py-3 bg-gray-50 border rounded text-gray-500 text-start hidden">
            ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </section>

    <!-- ì•¡ì…˜ -->
    <div class="mt-6 flex flex-col-reverse sm:flex-row justify-center sm:justify-end gap-2">
        <a th:href="@{'/as/edit/' + ${as.asId}}"
           class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">ìˆ˜ì •</a>
        <button th:onclick="|deleteAs(${as.asId})|"
                class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">ì‚­ì œ</button>
    </div>
</div>

<!-- ì‚­ì œ -->
<script>
    function deleteAs(asId) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      fetch(`/api/as/delete/${asId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) { alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); location.href = '/as/list'; }
          else { alert('ì‚­ì œ ì‹¤íŒ¨'); }
        })
        .catch(err => { alert('ìš”ì²­ ì˜¤ë¥˜ ë°œìƒ'); console.error(err); });
    }
</script>

<!-- ì™„ë£Œ(ì§€ê¸ˆ) ì²˜ë¦¬ -->
<script>
    function formatYmdHm(date){
      const p = n => (n<10 ? '0'+n : ''+n);
      return date.getFullYear()+'-'+p(date.getMonth()+1)+'-'+p(date.getDate())+' '+p(date.getHours())+':'+p(date.getMinutes());
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-complete-now');
      if (!btn) return;

      const card = btn.closest('.rounded-xl');
      const sid   = card.getAttribute('data-sid');
      const plan  = card.getAttribute('data-plan');     // ISO(yyyy-MM-ddTHH:mm:ss) or ''
      const cont  = card.getAttribute('data-content');  // string or ''

      if (!sid) return;
      if (!confirm('ì´ ì¼ì •ì„ ì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?\n(ì™„ë£Œì¼ = í˜„ì¬ ì‹œê°)')) return;

      const orig = btn.textContent;
      btn.disabled = true; btn.textContent = 'ì²˜ë¦¬ì¤‘...';

      try {
        const payload = {
          scheduleId: Number(sid),
          planDate:   plan || null,
          asContent:  cont || null
          // completeDateëŠ” ì„œë²„ì—ì„œ now()ë¡œ ê°•ì œ ì„¤ì •
        };

        const res = await fetch(`/api/as/schedule/${sid}/complete`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text().catch(()=> 'ìš”ì²­ ì‹¤íŒ¨'));
        const data = await res.json(); // { completeDate: 'yyyy-MM-dd HH:mm' }

        const span = card.querySelector('[data-complete-span]');
        if (span) span.textContent = data.completeDate || formatYmdHm(new Date());

        // ë²„íŠ¼ ì œê±° + "ì™„ë£Œë¨" í‘œì‹œ
        const container = btn.parentElement;
        btn.remove();
        const tag = document.createElement('span');
        tag.className = 'text-xs text-blue-600';
        tag.textContent = 'ì™„ë£Œë¨';
        container.appendChild(tag);

        // ìƒíƒœ ì¬ê³„ì‚° ë°˜ì˜
        location.reload();

      } catch (err) {
        alert('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message);
        btn.disabled = false; btn.textContent = orig;
      }
    });
</script>

<!-- ì²¨ë¶€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
<script th:inline="javascript">
    (function () {
      function getFileIcon(ext) {
        const m = { jpg:'ğŸ–¼ï¸', jpeg:'ğŸ–¼ï¸', png:'ğŸ–¼ï¸', gif:'ğŸ–¼ï¸', webp:'ğŸ–¼ï¸', bmp:'ğŸ–¼ï¸',
                    pdf:'ğŸ“„', doc:'ğŸ“„', docx:'ğŸ“„', ppt:'ğŸ“Š', pptx:'ğŸ“Š',
                    xls:'ğŸ“Š', xlsx:'ğŸ“Š', zip:'ğŸ—œï¸', txt:'ğŸ“ƒ' };
        return `<span>${m[ext] || 'ğŸ“'}</span>`;
      }

      const files = /*[[${as.fileList}]]*/ [];
      const listEl = document.getElementById('filePreviewList');
      const noEl   = document.getElementById('noFiles');
      const allBtn = document.getElementById('downloadAllBtn');

      if (!files || files.length === 0) { noEl.classList.remove('hidden'); return; }
      allBtn.classList.remove('hidden');

      files.forEach((file) => {
        const ext  = (file.originalName || '').split('.').pop().toLowerCase();
        const icon = getFileIcon(ext);
        const size = file.fileSize ? (file.fileSize / 1024).toFixed(1) + ' KB' : '';
        const url  = `${file.filePath}/${file.uuidName}`;

        const li = document.createElement('li');
        li.className = 'flex items-center justify-between border border-gray-200 rounded px-3 py-2 bg-white';
        li.innerHTML = `
          <div class="flex items-center gap-2 min-w-0">
            ${icon}
            <a href="${url}" class="text-blue-600 hover:underline truncate max-w-[220px] sm:max-w-[320px]"
               target="_blank" rel="noopener" title="${file.originalName || ''}">
              ${file.originalName || ''}
            </a>
            <span class="text-gray-400 text-xs">${size ? '(' + size + ')' : ''}</span>
          </div>
          <div class="flex items-center gap-2">
            <a href="${url}" target="_blank" rel="noopener"
               class="text-sm px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">ë³´ê¸°</a>
            <a href="${url}" download="${file.originalName || ''}"
               class="text-sm px-2 py-1 rounded border hover:bg-gray-50">ë‹¤ìš´ë¡œë“œ</a>
          </div>`;
        listEl.appendChild(li);
      });

      // ì „ì²´ ë‹¤ìš´ë¡œë“œ(ìˆœì°¨ ì‹¤í–‰)
      allBtn.addEventListener('click', () => {
        files.forEach((file, i) => {
          const a = document.createElement('a');
          a.href = `${file.filePath}/${file.uuidName}`;
          a.download = file.originalName || '';
          document.body.appendChild(a);
          setTimeout(() => { a.click(); a.remove(); }, i * 220);
        });
      });
    })();
</script>

</body>
</html>
