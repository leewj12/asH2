<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>As ë“±ë¡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body class="bg-gray-50 p-4 md:p-6 text-sm">
<div class="w-full mx-auto bg-white p-4 md:p-6 rounded-2xl shadow max-w-[1500px]">
    <header class="mb-4 md:mb-6">
        <h2 class="text-xl md:text-2xl font-semibold tracking-tight">ì ‘ìˆ˜ ë“±ë¡</h2>
<!--        <p class="text-gray-500 mt-1 text-xs md:text-sm">í•„ìˆ˜ í•­ëª©ë§Œ ê°„ë‹¨íˆ ì…ë ¥í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” í•„ìš” ì‹œ ì¶”ê°€í•˜ì„¸ìš”.</p>-->
    </header>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë†ì¥ ê²€ìƒ‰/ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="space-y-3 md:space-y-4 mb-5 md:mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 items-end">
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ë†ì¥ ì„ íƒ  <span class="text-rose-500">*</span></label>
                <select id="farmCode" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected hidden>ë†ì¥ ì„ íƒ</option>
                </select>
            </div>
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ë†ì¥ í•„í„°</label>
                <input type="text" id="farmSearch" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ë†ê°€ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥">
            </div>
        </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¥ë¹„ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 items-end">
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ì¥ë¹„ ì¹´í…Œê³ ë¦¬</label>
                <select id="tableName" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">ì¥ë¹„ ì„ íƒ</option>
                    <option value="UNREGISTERED">ë¯¸ë“±ë¡ ì¥ë¹„</option>
                </select>
            </div>
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ì¥ë¹„</label>
                <select id="equipmentSelect" class="w-full border rounded px-3 py-2 hidden focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                <input type="text" id="customEqmntName" placeholder="ì¥ë¹„ëª… ì…ë ¥ (ë¯¸ë“±ë¡ìš©)" class="w-full border rounded px-3 py-2 hidden focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <div id="equipmentPlaceholder" class="h-[40px] invisible"></div>
            </div>
            <div class="flex flex-col justify-end">
                <button type="button" id="addEquipBtn" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg">ì¥ë¹„ ì¶”ê°€</button>
            </div>
        </div>

        <!-- ì¥ë¹„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
        <div id="equipTableContainer" class="mt-4 md:mt-5 hidden">
            <div id="equipCardGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4"></div>
        </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¬¸ì œ ìœ í˜•(ì„ íƒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <label class="block text-sm font-medium text-gray-700">ë¬¸ì œ ìœ í˜• <span class="text-gray-400 font-normal">(ì„ íƒ)</span></label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-1">
            <select id="asTypeSelect" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="ê¸°íƒ€" selected>ì„ íƒ ì•ˆí•¨</option>
                <option value="ì¥ë¹„">ì¥ë¹„</option>
                <option value="ë„¤íŠ¸ì›Œí¬">ë„¤íŠ¸ì›Œí¬</option>
                <option value="ëª¨ë“ˆ">ëª¨ë“ˆ</option>
                <option value="CUSTOM">ê¸°íƒ€(ì§ì ‘ ì…ë ¥)</option>
            </select>
            <input type="text" id="asTypeCustom" class="w-full border rounded px-3 py-2 hidden focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ê¸°íƒ€ ìœ í˜•ì„ ì…ë ¥ (ì„ íƒ)">
        </div>
        <p class="text-xs text-gray-500 mt-1">ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ â€˜ê¸°íƒ€â€™ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì ‘ìˆ˜ì/ë“±ë¡ì/ì¼ì â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ì</label>
                <input type="text" id="reqUser" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">AS ë‹´ë‹¹ì</label>
                <input type="text" id="asManager" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ì¼ì</label>
                <input type="datetime-local" id="reqDate" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì ‘ìˆ˜ ë‚´ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ ë‚´ìš©</label>
        <textarea id="reqContent" rows="3" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¼ì • ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <div class="flex items-baseline justify-between">
            <label class="block text-sm font-medium text-gray-700">ì¼ì •</label>
<!--            <span class="text-xs text-gray-400">ì˜ˆì •ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.</span>-->
        </div>
        <div id="scheduleListContainer" class="space-y-3 mt-2"></div>
        <button type="button" id="addScheduleBtn" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg w-full sm:w-auto">ì¼ì • ì¶”ê°€</button>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¡°ì¹˜ ê²°ê³¼ / ë¹„ê³  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6 grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">ì¡°ì¹˜ ê²°ê³¼</label>
            <textarea id="asResult" rows="4" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">ë¹„ê³ </label>
            <textarea id="etc" rows="4" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒíƒœ ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-5 md:mb-6">
        <label class="block text-sm font-medium text-gray-700">AS ìƒíƒœ</label>
        <label class="inline-flex items-center mt-2 select-none">
            <input type="checkbox" id="statusFlag" class="mr-2">
            <span class="text-gray-700">ë³´ë¥˜ë¡œ ë“±ë¡</span>
        </label>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì²¨ë¶€íŒŒì¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="mb-6">
        <label for="asFile" class="block text-sm font-medium text-gray-700 mb-2">ì²¨ë¶€íŒŒì¼</label>
        <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-4 bg-gray-50 text-center hover:border-blue-400">
            <input type="file" id="asFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple>
            <div class="flex flex-col items-center justify-center space-y-1 pointer-events-none">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v9m0 0l-3-3m3 3l3-3m0-12a4 4 0 00-8 0v4a4 4 0 008 0V5z"/>
                </svg>
                <p class="text-gray-500 text-sm">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
            </div>
        </div>
        <ul id="filePreviewList" class="mt-3 space-y-2 text-sm text-gray-700"></ul>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <footer class="mt-6 flex flex-col sm:flex-row gap-2 justify-center sm:justify-end">
        <button id="submitBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">ë“±ë¡</button>
    </footer>
</div>

<script>
    // --- ìƒíƒœ ---
    const equipList = [];
    const scheduleList = [];

    // --- ìœ í‹¸ ---
    const fmt = v => (v ?? '').toString();
    const fmtDate19 = v => v ? String(v).substring(0, 19) : null;

    // --- ë ˆì´ì•„ì›ƒ í† ê¸€(placeholderë¡œ ë†’ì´ ìœ ì§€) ---
    function toggleEquipInputs(state) { // 'none' | 'custom' | 'select'
      const $eq = $('#equipmentSelect');
      const $custom = $('#customEqmntName');
      const $ph = $('#equipmentPlaceholder'); // h-[40px] invisible

      if (state === 'none') {
        $eq.addClass('hidden');
        $custom.addClass('hidden');
        $ph.removeClass('hidden').addClass('invisible'); // ê³µê°„ ìœ ì§€
      } else if (state === 'custom') {
        $eq.addClass('hidden');
        $custom.removeClass('hidden');
        $ph.addClass('hidden'); // ì™„ì „ ìˆ¨ê¹€
      } else { // 'select'
        $custom.addClass('hidden');
        $eq.removeClass('hidden');
        $ph.addClass('hidden');
      }
    }

    // --- (ì´ì „ í˜¸í™˜) AS ìœ í˜• ìë™ê°±ì‹ ì€ ì‚¬ìš© ì•ˆ í•¨
    function updateAsTypeField() { /* intentionally no-op */ }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¥ë¹„ ì¹´ë“œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawEquipTable() {
      const $container = $('#equipTableContainer');
      const $grid = $('#equipCardGrid').empty();

      if (equipList.length === 0) { $container.addClass('hidden'); return; }
      $container.removeClass('hidden');

      equipList.forEach((e, i) => {
        const tableName = (e.tableName || '').toString().toUpperCase();
        const badgeClass = tableName === 'UNREGISTERED'
          ? 'bg-rose-50 text-rose-700 border-rose-200'
          : (tableName === 'SF_TBL_EQMNT' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-slate-100 text-slate-700 border-slate-200');
        const kindLabel = tableName === 'SF_TBL_EQMNT' ? 'EQMNT_KIND' : 'SUB_SEQ';
        const kindValue = tableName === 'SF_TBL_EQMNT' ? (e.eqmntKind ?? '-') : (e.subSeq ?? '-');

        const card = `
          <div class="rounded-xl border border-gray-200 bg-white p-3 shadow-sm">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold truncate">${fmt(e.eqmntName) || 'ë¯¸ë“±ë¡ ì¥ë¹„'}</div>
                <div class="mt-1 text-xs text-gray-500 flex flex-wrap gap-2 items-center">
                  <span class="inline-flex items-center text-[11px] px-2 py-0.5 rounded-full border ${badgeClass}">${tableName || 'UNKNOWN'}</span>
                </div>
              </div>
              <button onclick="removeEquip(${i})" class="shrink-0 text-rose-600 hover:text-rose-700 text-xs px-2 py-1 rounded border border-rose-200 hover:bg-rose-50">ì‚­ì œ</button>
            </div>

            <div class="mt-2 space-y-1.5 text-sm">
              <div class="flex">
                <span class="w-24 text-gray-500 shrink-0">EQMNT_SEQ</span>
                <span class="text-gray-800 break-all">${fmt(e.eqmntSeq) || '-'}</span>
              </div>
              <div class="flex">
                <span class="w-24 text-gray-500 shrink-0">${kindLabel}</span>
                <span class="text-gray-800 break-all">${fmt(kindValue)}</span>
              </div>
              <div class="flex">
                <span class="w-24 text-gray-500 shrink-0">ì„¤ì¹˜ì¼</span>
                <span class="text-gray-800">${fmt(e.useDate) || '-'}</span>
              </div>
            </div>
          </div>`;
        $grid.append(card);
      });
    }
    function removeEquip(idx) {
      equipList.splice(idx, 1);
      drawEquipTable();
      updateAsTypeField();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¼ì • ë¸”ë¡ ë Œë”ë§(ì¹´ë“œí˜•) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawScheduleBlocks() {
      const $container = $('#scheduleListContainer').empty();
      scheduleList.forEach((s, i) => {
        const block = `
          <div class="rounded-xl border border-gray-200 bg-white shadow-sm p-3 md:p-4">
            <div class="flex items-baseline justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                <span class="text-sm font-medium text-gray-800">ì¼ì • #${i+1}</span>
              </div>
              <button type="button" onclick="removeSchedule(${i})" class="text-rose-600 hover:text-rose-700 text-xs px-2 py-1 rounded border border-rose-200 hover:bg-rose-50">ì‚­ì œ</button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <label class="text-xs text-gray-500">ì˜ˆì •ì¼ <span class="text-rose-500">*</span></label>
                <input type="datetime-local" class="w-full border rounded px-2 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       value="${fmt(s.planDate)}"
                       onchange="scheduleList[${i}].planDate = this.value">
              </div>
              <div>
                <label class="text-xs text-gray-500">ì™„ë£Œì¼</label>
                <input type="datetime-local" class="w-full border rounded px-2 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       value="${fmt(s.completeDate)}"
                       onchange="scheduleList[${i}].completeDate = this.value">
              </div>
              <div class="sm:col-span-1"></div>
            </div>

            <div class="mt-3">
              <label class="text-xs text-gray-500">ì ê²€ ë‚´ìš©</label>
              <textarea class="w-full border rounded px-2 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"
                        onchange="scheduleList[${i}].asContent = this.value">${fmt(s.asContent)}</textarea>
            </div>
          </div>`;
        $container.append(block);
      });
    }
    function removeSchedule(i) {
      scheduleList.splice(i, 1);
      drawScheduleBlocks();
    }

    // ì¼ì • ì¶”ê°€ ë²„íŠ¼
    $('#addScheduleBtn').on('click', function () {
      scheduleList.push({ planDate: '', completeDate: '', asContent: '' });
      drawScheduleBlocks();
    });

    // --- ë¬¸ì œ ìœ í˜•: ê¸°íƒ€ ì„ íƒ ì‹œ ì…ë ¥ì°½ í† ê¸€ (nullable í—ˆìš©) ---
    function toggleAsTypeCustom() {
      const v = $('#asTypeSelect').val();
      if (v === 'CUSTOM') {
        $('#asTypeCustom').removeClass('hidden').trigger('focus');
      } else {
        $('#asTypeCustom').addClass('hidden').val('');
      }
    }
    $('#asTypeSelect').on('change', toggleAsTypeCustom);

    // --- ë†ì¥ ìë™ì™„ì„±(ë””ë°”ìš´ìŠ¤) ---
    let debounceTimer;
    $('#farmSearch').on('input', function () {
      clearTimeout(debounceTimer);
      const keyword = $(this).val();
      debounceTimer = setTimeout(() => {
        $.get('/api/as/searchFarmList', { keyword }, function (list) {
          const $farmCode = $('#farmCode').empty();
          $farmCode.append('<option value="" disabled selected hidden>ë†ì¥ ì„ íƒ</option>');
          list.forEach(f => $farmCode.append(`<option value="${f.FARM_CODE}">${f.FARM_NAME} (${f.FARM_CODE})</option>`));
        });
      }, 300);
    });

    // --- ì´ˆê¸° ë¡œë”© ---
    $(function () {
      $.get('/api/as/searchFarmList', { keyword: '' }, function (list) {
        const $farmCode = $('#farmCode').empty();
        $farmCode.append('<option value="" disabled selected hidden>ë†ì¥ ì„ íƒ</option>');
        list.forEach(f => $farmCode.append(`<option value="${f.FARM_CODE}">${f.FARM_NAME} (${f.FARM_CODE})</option>`));
      });
      toggleEquipInputs('none'); // ìµœì´ˆì—” placeholderë¡œ ë†’ì´ ìœ ì§€
    });

    // --- ë†ì¥ ë³€ê²½: ì¥ë¹„/ì¼ì • ì´ˆê¸°í™” + ì¹´í…Œê³ ë¦¬ ë¡œë”© ---
    $('#farmCode').on('change', function () {
      const farmCode = $(this).val();
      if (!farmCode) return;

      equipList.length = 0; drawEquipTable(); updateAsTypeField();
      scheduleList.length = 0; drawScheduleBlocks();

      $.get('/api/as/categoryList', { farmCode }, function (list) {
        const $table = $('#tableName');
        $table.empty().append('<option value="">ì¥ë¹„ ì„ íƒ</option><option value="UNREGISTERED">ë¯¸ë“±ë¡ ì¥ë¹„</option>');
        [...new Set(list)].forEach(tn => $table.append(`<option value="${tn}">${tn}</option>`));
      });

      toggleEquipInputs('none');
    });

    // --- ì¹´í…Œê³ ë¦¬ ë³€ê²½: ì¥ë¹„ ëª©ë¡ or ë¯¸ë“±ë¡ ì…ë ¥ ë…¸ì¶œ ---
    $('#tableName').on('change', function () {
      const table = $(this).val();
      const farmCode = $('#farmCode').val();
      const $eq = $('#equipmentSelect');

      if (!table || !farmCode) { toggleEquipInputs('none'); return; }
      if (table === 'UNREGISTERED') { toggleEquipInputs('custom'); return; }

      toggleEquipInputs('select');

      $.get('/api/as/equipmentList', { farmCode, tableName: table }, function (list) {
        $eq.empty().append('<option value="">ì„ íƒ</option>');
        list.forEach((raw, i) => {
          // ë§¤í¼ê°€ SUB_SEQ(=EQMNT_KIND for EQMNT)ë¡œ í†µì¼í•´ì„œ ë‚´ë ¤ì¤Œ
          const item = {
            EQMNT_SEQ:  raw.EQMNT_SEQ ?? null,
            SUB_SEQ:    (raw.SUB_SEQ ?? raw.EQMNT_KIND ?? null),
            EQMNT_NAME: raw.EQMNT_NAME ?? '',
            USE_DATE:   raw.USE_DATE ?? null
          };
          const label = `[${item.EQMNT_SEQ ?? ''}-${item.SUB_SEQ ?? ''}] ${item.EQMNT_NAME}`;
          const $opt = $('<option>').val(String(i)).text(label).data('equip', item);
          $eq.append($opt);
        });
      });
    });

    // --- ì¥ë¹„ ì¶”ê°€ ---
    $('#addEquipBtn').on('click', function () {
      const farmCode = $('#farmCode').val();
      const tableName = $('#tableName').val();
      if (!farmCode || !tableName) return alert('ë†ì¥ê³¼ ì¥ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”');

      let data = { farmCode, tableName, useFlag: '1' };

      if (tableName === 'UNREGISTERED') {
        const name = $('#customEqmntName').val();
        if (!name) return alert('ì¥ë¹„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        data.eqmntName = name;
      } else {
        const $opt = $('#equipmentSelect option:selected');
        const item = $opt.data('equip');
        if (!item) return alert('ì¥ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”');

        const isEqmnt = tableName === 'SF_TBL_EQMNT';
        data.eqmntSeq  = item.EQMNT_SEQ || null;
        data.subSeq    = isEqmnt ? null : (item.SUB_SEQ || null);
        data.eqmntKind = isEqmnt ? (item.SUB_SEQ || null) : null;   // EQMNTë§Œ kind ì‚¬ìš©
        data.eqmntName = item.EQMNT_NAME || null;
        data.useDate   = fmtDate19(item.USE_DATE);

        const isDuplicate = equipList.some(e =>
          e.tableName === tableName &&
          e.eqmntSeq === data.eqmntSeq &&
          (e.subSeq ?? e.eqmntKind) === (data.subSeq ?? data.eqmntKind)
        );
        if (isDuplicate) return alert('ì´ë¯¸ ì¶”ê°€ëœ ì¥ë¹„ì…ë‹ˆë‹¤');
      }

      equipList.push(data);
      drawEquipTable();
      updateAsTypeField();
    });

    // --- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ---
    const fileInput = document.getElementById('asFile');
    const fileList = [];
    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const preview = document.getElementById('filePreviewList');
        preview.innerHTML = '';
        fileList.length = 0;

        Array.from(fileInput.files).forEach((file, index) => {
          fileList.push(file);
          const ext = file.name.split('.').pop().toLowerCase();
          const icon = getFileIcon(ext);
          const size = (file.size / 1024).toFixed(1) + ' KB';
          const item = document.createElement('li');
          item.className = 'flex items-center justify-between border border-gray-200 rounded px-3 py-2 bg-white';
          item.innerHTML = `
            <div class=\"flex items-center gap-2 min-w-0\">
              ${icon}
              <span class=\"truncate max-w-[220px] sm:max-w-[320px]\">${file.name}</span>
              <span class=\"text-gray-400 text-xs\">(${size})</span>
            </div>
            <button type=\"button\" onclick=\"removeFile(${index})\" class=\"text-red-500 text-sm hover:underline\">ì‚­ì œ</button>`;
          preview.appendChild(item);
        });
      });
    }
    function getFileIcon(ext){
      const map={jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',pdf:'ğŸ“„',doc:'ğŸ“„',docx:'ğŸ“„',ppt:'ğŸ“Š',pptx:'ğŸ“Š',xls:'ğŸ“Š',xlsx:'ğŸ“Š',zip:'ğŸ—œï¸',txt:'ğŸ“ƒ'};
      return `<span>${map[ext]||'ğŸ“'}</span>`;
    }
    function removeFile(index){
      const preview=document.getElementById('filePreviewList');
      if (!preview) return;
      if (preview.children[index]) preview.removeChild(preview.children[index]);
      fileList.splice(index,1);
      const dt=new DataTransfer(); fileList.forEach(f=>dt.items.add(f)); fileInput.files=dt.files;
    }

    // --- ë“±ë¡ ë²„íŠ¼ ---
    $('#submitBtn').on('click', function () {
      const farmCode = $('#farmCode').val();
      if (!farmCode || farmCode.trim() === '') return alert('ë†ì¥ì„ ì„ íƒí•˜ì„¸ìš”.');

      // ë¬¸ì œ ìœ í˜•: nullable í—ˆìš©
      const sel = $('#asTypeSelect').val();
      let asTypeValue = null;
      if (sel === 'CUSTOM') {
        const custom = ($('#asTypeCustom').val() || '').trim();
        asTypeValue = custom || 'ê¸°íƒ€'; // ë¹ˆ ë¬¸ìì—´ì´ë©´ ê¸°íƒ€ ì €ì¥
      } else if (sel) {
        asTypeValue = sel; // 'ì¥ë¹„' | 'ë„¤íŠ¸ì›Œí¬' | 'ëª¨ë“ˆ'
      } // selì´ ë¹ˆ ê°’ì´ë©´ null ìœ ì§€

      for (const [i,s] of scheduleList.entries()){
        if (!s.planDate || s.planDate.trim() === '') return alert(`ì¼ì • ${i+1}ë²ˆì˜ ì˜ˆì •ì¼ì„ ì…ë ¥í•˜ì„¸ìš”`);
      }

      const dto = {
        farmCode,
        reqDate   : $('#reqDate').val() ? $('#reqDate').val() + ':00' : null,
        reqUser   : $('#reqUser').val(),
        asManager : $('#asManager').val(),
        asType    : asTypeValue, // âœ… nullable ë°˜ì˜
        reqContent: $('#reqContent').val(),
        asResult  : $('#asResult').val(),
        etc       : $('#etc').val(),
        statusFlag: !$('#statusFlag').is(':checked'),
        equipList,
        scheduleList
      };

      $.ajax({
        url: '/api/as/write',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dto),
        success: (asId) => {
          const input = document.getElementById('asFile');
          const files = input?.files || [];
          if (!files.length) return window.location.href = '/as/list';

          const formData = new FormData();
          for (const file of files) formData.append('files', file);
          formData.append('asId', asId);

          fetch('/api/as/file/upload', { method: 'POST', body: formData })
            .then(res => res.ok ? res.text() : Promise.reject(res.statusText))
            .then(() => { alert('ë“±ë¡ ë° íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ'); window.location.href = '/as/list'; })
            .catch(err => alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err));
        },
        error: () => alert('ë“±ë¡ ì‹¤íŒ¨')
      });
    });
</script>

</body>
</html>