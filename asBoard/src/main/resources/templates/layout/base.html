<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8" />
    <title layout:title-pattern="$CONTENT_TITLE Â· AS ê²Œì‹œíŒ">AS ê²Œì‹œíŒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- favicon -->
<!--    <link rel="shortcut icon" href="/favicon.ico">-->
</head>

<body class="bg-gray-50 text-sm min-h-screen">
<!-- ëª¨ë°”ì¼ ìƒë‹¨ë°” -->
<header class="md:hidden fixed top-0 inset-x-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="h-12 flex items-center justify-between px-4">
        <button id="sb-open" class="p-2" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>
        <a href="/as/list" class="font-semibold">AS ê´€ë¦¬</a>
        <span class="w-6 h-6"></span>
    </div>
</header>


<!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´(ëª¨ë°”ì¼ ì „ìš©) -->
<div id="sb-backdrop"
     class="fixed inset-0 bg-black/40 z-30 hidden md:hidden"></div>

<!-- âœ… ë°ìŠ¤í¬í†± í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ ìˆ¨ê¹€) -->
<button id="sb-toggle-desktop"
        class="hidden md:flex items-center gap-2 fixed top-3 left-3 z-50
               bg-white/90 backdrop-blur border rounded px-3 h-9 shadow-sm
               hover:bg-white"
        type="button" aria-label="ì‚¬ì´ë“œë°” í† ê¸€">
    â˜°
</button>

<div class="flex">
    <!-- âœ… ë°˜ì‘í˜•/í† ê¸€ ì‚¬ì´ë“œë°” -->
    <aside id="sidebar"
           class="fixed inset-y-0 left-0 z-40
                  w-64 lg:w-72 xl:w-80
                  bg-white border-r overflow-y-auto
                  -translate-x-full md:translate-x-0
                  transition-transform duration-200 ease-out">
        <!-- ìƒë‹¨ ë¡œê³ /íƒ€ì´í‹€ -->
        <div class="sticky top-1 h-20 bg-white px-4 md:pl-16 py-3 font-bold text-xl border-b text-black-600">
            <div class="flex items-center justify-between">
                <a href="/as/dashboard" class="font-bold">AS ê´€ë¦¬</a>
                <button id="sb-close" class="md:hidden p-2" aria-label="ë©”ë‰´ ë‹«ê¸°">âœ•</button>
            </div>
        </div>

        <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ ë°•ìŠ¤ -->
        <div id="authBox" class="m-3 p-3 rounded-lg border bg-gray-50 text-sm">
            <!-- JSê°€ ì±„ì›ë‹ˆë‹¤ -->
            <div class="text-gray-500">í™•ì¸ ì¤‘...</div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="p-3 space-y-1 text-base">
            <a href="/as/dashboard"
               class="block px-4 py-2 rounded hover:bg-gray-100"
               th:classappend="${currentPath.startsWith('/as/dashboard')} ?
              'bg-blue-100 text-blue-700' : ''">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>

            <a href="/as/write"
               class="block px-4 py-2 rounded hover:bg-gray-100"
               th:classappend="${currentPath.startsWith('/as/write')} ?
              'bg-blue-100 text-blue-700' : ''">ğŸ“ ì ‘ìˆ˜ ë“±ë¡</a>

            <a href="/as/list"
               class="block px-4 py-2 rounded hover:bg-gray-100"
               th:classappend="${currentPath.startsWith('/as/list')} ?
              'bg-blue-100 text-blue-700' : ''">ğŸ“„ ì ‘ìˆ˜ ëª©ë¡</a>

            <a href="/as/calendar"
               class="block px-4 py-2 rounded hover:bg-gray-100"
               th:classappend="${currentPath.startsWith('/as/calendar')} ?
              'bg-blue-100 text-blue-700' : ''">ğŸ“… ì¼ì • ê´€ë¦¬</a>

            <a href="/as/schedule"
               class="block px-4 py-2 rounded hover:bg-gray-100"
               th:classappend="${currentPath.startsWith('/as/schedule')} ?
              'bg-blue-100 text-blue-700' : ''">ğŸ“‹ ì¼ì • ë‚´ì—­</a>

        </nav>

    </aside>

    <!-- âœ… ë³¸ë¬¸ -->
    <main id="mainArea"
          class="min-w-0 flex-1 p-4 md:p-6 pt-12 md:pt-6 md:ml-64 lg:ml-72 xl:ml-80"
          layout:fragment="content"></main>

</div>

<script>
    (function () {
      const sidebar    = document.getElementById('sidebar');
      const backdrop   = document.getElementById('sb-backdrop');
      const openBtn    = document.getElementById('sb-open');   // ëª¨ë°”ì¼ í–„ë²„ê±°
      const closeBtn   = document.getElementById('sb-close');  // ëª¨ë°”ì¼ X
      const deskToggle = document.getElementById('sb-toggle-desktop');
      const main       = document.getElementById('mainArea');

      const mqMd = window.matchMedia('(min-width: 768px)');
      const isMobile = () => !mqMd.matches;

      // ë³¸ë¬¸ ì¢Œì¸¡ ë§ˆì§„(ì‚¬ì´ë“œë°” í­ê³¼ ë™ê¸°)
      const marginClasses = ['md:ml-64','lg:ml-72','xl:ml-80'];
      const addMargins    = () => marginClasses.forEach(c => main.classList.add(c));
      const removeMargins = () => marginClasses.forEach(c => main.classList.remove(c));

      // ë°ìŠ¤í¬íƒ‘ì—ì„œ "ë‹«í˜"ì„ ê¸°ì–µ (í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ ì§€)
      let desktopCollapsed = false;

      // âœ… ì‚¬ì´ë“œë°” í† ê¸€ í›„ ë‹¬ë ¥/ì»¨í…ì¸ ì— ë¦¬ì‚¬ì´ì¦ˆ ì•Œë¦¼ ë³´ë‚´ê¸° (íŠ¸ëœì§€ì…˜ ê³ ë ¤)
      const announceShellResize = (() => {
        let t;
        return () => {
          clearTimeout(t);
          t = setTimeout(() => {
            window.dispatchEvent(new Event('shell:sidebar-resize'));
          }, 230); // ì‚¬ì´ë“œë°” transition-duration:200ms + ì—¬ìœ 
        };
      })();

      const open = () => {
        if (isMobile()) {
          // ëª¨ë°”ì¼: ì‚¬ì´ë“œë°” ë³´ì—¬ì£¼ê³  ì˜¤ë²„ë ˆì´ ON
          sidebar.classList.remove('-translate-x-full');
          backdrop.classList.remove('hidden');
        } else {
          // ë°ìŠ¤í¬íƒ‘: md:-translate-x-full ì œê±° + md:translate-x-0 ì¶”ê°€
          sidebar.classList.remove('md:-translate-x-full', '-translate-x-full');
          sidebar.classList.add('md:translate-x-0');
          addMargins();
          desktopCollapsed = false;
        }
        announceShellResize();            // âœ… ì¶”ê°€
      };

      const close = () => {
        if (isMobile()) {
          // ëª¨ë°”ì¼: ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê³  ì˜¤ë²„ë ˆì´ OFF
          sidebar.classList.add('-translate-x-full');
          backdrop.classList.add('hidden');
        } else {
          // ë°ìŠ¤í¬íƒ‘: md:translate-x-0 ì œê±° + md:-translate-x-full ì¶”ê°€
          sidebar.classList.remove('md:translate-x-0');
          sidebar.classList.add('md:-translate-x-full');
          removeMargins();
          desktopCollapsed = true;
        }
        announceShellResize();            // âœ… ì¶”ê°€
      };

      const toggleDesktop = () => {
        if (isMobile()) return; // ëª¨ë°”ì¼ì€ í–„ë²„ê±°ë¡œë§Œ
        if (sidebar.classList.contains('md:-translate-x-full')) {
          open();
        } else {
          close();
        }
      };

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      openBtn?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      backdrop?.addEventListener('click', close);
      deskToggle?.addEventListener('click', toggleDesktop);

      // ESCë¡œ ë‹«ê¸°
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });

      // ë°˜ì‘í˜• ì „í™˜ ì‹œ ìƒíƒœ ì •ë¦¬
      const handle = () => {
        if (mqMd.matches) {
          // ë°ìŠ¤í¬íƒ‘ ì§„ì…: ì´ì „ ìƒíƒœ ìœ ì§€
          if (desktopCollapsed) close(); else open();
          deskToggle?.classList.remove('hidden');
        } else {
          // ëª¨ë°”ì¼ ì§„ì…: ê¸°ë³¸ ë‹«í˜
          deskToggle?.classList.add('hidden');
          sidebar.classList.add('-translate-x-full');
          sidebar.classList.remove('md:translate-x-0','md:-translate-x-full');
          backdrop.classList.add('hidden');
          removeMargins();
          announceShellResize();            // âœ… ì¶”ê°€
        }
      };

       sidebar.addEventListener('transitionend', (e) => {
        if (e.propertyName === 'transform') announceShellResize();
      });

      mqMd.addEventListener?.('change', handle);
      handle(); // ì´ˆê¸° ì ìš©
    })();
</script>

<!-- jwt -->
<script src="/js/auth.js"></script>

<script>
    (async function () {
      const box = document.getElementById('authBox');
      if (!box) return;

      // í˜„ì¬ ê²½ë¡œë¥¼ redirectë¡œ ì‚¬ìš©
      const redirect = encodeURIComponent(location.pathname + location.search);

      try {
        // ì—¬ê¸°ì„  401/ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì§€í•˜ë ¤ê³  plain fetch ì‚¬ìš© (permitAll ê¸°ì¤€)
        const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('me fail');
        const data = await res.json();

        if (data.authenticated) {
          box.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
<!--                <div class="text-gray-500">ë¡œê·¸ì¸ ì¤‘</div>-->
                <div class="font-semibold text-gray-900 truncate">@${data.username}</div>
              </div>
              <button id="btnLogout"
                class="shrink-0 rounded-md border px-3 py-1.5 bg-red-600 text-white font-bold hover:bg-red-500">
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          `;
          document.getElementById('btnLogout')?.addEventListener('click', async () => {
            // auth.jsì˜ doLogout ì‚¬ìš© (ì—†ìœ¼ë©´ POST /api/auth/logout í˜¸ì¶œ)
            if (window.doLogout) { await window.doLogout(); }
            else {
              await fetch('/api/auth/logout', { method:'POST', credentials:'same-origin' });
              location.href = '/login';
            }
          });

        } else {
          box.innerHTML = `
              <div class="space-y-2">
                <div class="text-gray-700">ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.</div>
                <div class="flex items-center gap-2">
                  <a class="shrink-0 rounded-md bg-slate-900 text-white px-3 py-1.5 hover:bg-slate-800"
                     href="/login?redirect=${redirect}">
                    ë¡œê·¸ì¸
                  </a>
                  <a class="shrink-0 rounded-md border border-slate-300 px-3 py-1.5 text-slate-700 hover:bg-slate-50"
                     href="/signup?redirect=${redirect}">
                    íšŒì›ê°€ì…
                  </a>
                </div>
              </div>
          `;
        }
      } catch (e) {
        // ì‹¤íŒ¨ ì‹œ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸ ë²„íŠ¼ë§Œ ë…¸ì¶œ
        box.innerHTML = `
            <div class="space-y-2">
              <div class="text-gray-700">ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
              <div class="flex items-center gap-2">
                <a class="shrink-0 rounded-md bg-slate-900 text-white px-3 py-1.5 hover:bg-slate-800"
                   href="/login?redirect=${redirect}">
                  ë¡œê·¸ì¸
                </a>
                <a class="shrink-0 rounded-md border border-slate-300 px-3 py-1.5 text-slate-700 hover:bg-slate-50"
                   href="/signup?redirect=${redirect}">
                  íšŒì›ê°€ì…
                </a>
              </div>
            </div>
        `;
      }
    })();
</script>

</body>
</html>